# 精读《Prettier your project》

## 1.引言
本周精读的文章是 [Prettier your project](https://blog.souche.com/prettier-your-project/?from=timeline)，让我们通过本文，对目前流行项目中格式化代码的工具 `prettier` 进行了解，并且明白格式化代码对于整个项目代码质量把控的重要性。

## 2.概述 & 精读

在几年前之前我们刚接触前端并开始书写 `js` 代码时，我们并不存在所谓的代码格式规范，大家大多数时候都在自由发挥，这导致了多人项目中维护的困难。因为每个人的习惯和对细节的要求都不尽相同，代码风格不统一，而这种不统一还将伴随着项目结构的扩大变得越发严重，最后不同业务模块之间可能就是完全迥异的代码，为了维护代码必然要适应不同的代码风格，平白增加了维护成本。

在这个时候我们就需要规范整个团队的代码，但是团队间讨论代码规范却很难真正统一，正如前文所述，每个人的习惯和对于细节的要求不尽相同，我们需要的是更**强制性**的工具，来确保我们的代码保持统一的风格。

### 什么是 `prettier`

通过 `prettier` 的官网，我们可以得知这是一个比较任性（配置少，内置规则）的 `代码格式化` 工具，其拥有庞大的用户群体，简易的格式化方式，以及深思熟虑的格式化方案等优点。

#### 设计原则

##### 准确性
因为格式化是个黑盒过程，我们并不知道这其中到底发生了什么，只知道我们按下了一个键，然后代码经过了神奇的魔法变得很规范了，但是这会造成我们的代码出错吗，我们无从得知，所以`准确性`是代码格式化工具的第一准则。而这种准确性的实现，是需要预知格式化后的代码是否会存在问题的，文章就用了几个例子来说明这种情况。

```javascript
// before
if (shouldAddLines) {
  [-1, 1].forEach(delta => addLine(delta * 20))
}
// after prettier --no-semi
if (shouldAddLines) {
  ;[-1, 1].forEach(delta => addLine(delta * 20))
}
```
乍一看感觉这个格式化其实很没必要，但是这是一个防御性的措施，因为在没有分号的情况下，如果没有增加这个`;`，很有可能会出现问题，比如原来的代码如下：

```javascript
 if (shouldAddLines) {
+  console.log('Do we even get here??')
   [-1, 1].forEach(delta => addLine(delta * 20))
 }
```
那么其格式化后如果没有这个分号会变成：
```javascript
// after fomate 
if (shouldAddLines) {  
  console.log('Do we even get here??')[-1, 1].forEach(delta => addLine(delta * 20))
}
```
这明显会导致代码抛错，所以由此可见，`prettier`格式化的时候是会考虑到格式化后的代码的准确性的。

##### 易读性
格式化代码的目的除了方便团队统一风格，当然也包括让代码变得更加易于理解和阅读，`prettier` 在这上面的处理可以从文中提及的几点看出：

- 多行对象的格式化依赖于用户写法，而并非是长短，这实则是工具通过你的初始写法进行判断的结果，能够很好地保证格式化的代码和你的预期接近。

- 在一些方法中可能会出现的描述说明超长的情况，但是 `prettier` 并不会一刀切的死板格式化。

- 为了保证 `prettier` 始终如一的统一风格，其格式化规则是不允许被删除的，开关规则只会改变统一的方式。

#### 与 `ESLINT` 的关系
在不了解 `prettier` 之前，笔者也有过疑问，既然已经有了 `eslint` 格式化为何还需要 `prettier` 呢？实际上其并没有和 `eslint` 冲突，只能说有一些功能的重叠而已。

`eslint`的定位是**校验代码工具**，其更关注的是代码的质量，格式化是其额外功能，而 `prettier` 则定位为**代码格式化工具**，其关注的便是如何让代码更加规范，以及可读性更高，但是对于代码内部的质量问题并不会去处理。但是二者的目的还是一致的，都是为了统一代码风格，并且尽量减少和避免 bug。

相比 `eslint` 的海量的配置，`prettier` 通过内置不可修改规则 + 暴露少数具有争议性的个规则配置，来达到对代码的**强制性**统一。

### 最佳实践
在我们的日常开发中，相信大家都会使用到 `eslint` 来把控代码的质量和统一风格，那如果我们再加上 `prettier` 来进行代码格式化，无疑对项目有益无害，但是其会存在一个问题：

  - `eslint` 是自带格式化功能和规则的，而 `prettier` 也有自己内置的不可修改的规则，这很可能会造成冲突。

为了解决这个问题，我们可以通过安装 `eslint` 的 `prettier` 插件，再将 `prettier` 的插件放置为继承列表最后提高其权重，当出现规则冲突时，则会始终使用 `prettier` 的规则来处理。

```bash
yarn add --dev eslint-config-prettier eslint-plugin-prettier  
```

.eslintrc.json
```json
{
  ...
  "extends": ["plugin:prettier/recommended"]
}
```
至此，当运行 `eslint --fix` 时便会自动格式化，但是在项目里还是有一些不足之处，因为这样做还是需要手动触发格式化，我们希望的是更自动化的流程（毕竟我们都懒），于是我们可以使用 `git` 的 `pre-commit` 钩子来达到提交前自动格式化的效果：

```bash
yarn add pretty-quick husky --dev  
```

package.json

```json
{
  ...
  "husky": {
    "hooks": {
      "pre-commit": "pretty-quick --staged"
    }
  }
}
```

## 总结
如今的时代前端越来越重要，代码质量和规范将是未来不可避免的问题，如善用工具，将极大地减少代码出错几率并且提高代码的可读性，这一步，不妨就先从 `eslint` 和 `prettier` 开始吧。